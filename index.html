<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TECLA Adapta PRIME ‚Äî Chat Visual com Emo√ß√µes</title>
<style>
  :root{
    --bg:#0f1720; --panel:#0b1220; --muted:#8b98a7; --accent:#06d6a0;
    --happy-bg:#fff7c2; --sad-bg:#d7f0ff; --angry-bg:#ffd6d6; --calm-bg:#dfffe6; --curious-bg:#f3e8ff;
    --neutral-bg:#f4f4f5;
  }
  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", system-ui, -apple-system, sans-serif;background:linear-gradient(180deg,#071829 0%, #0d1b2a 100%);color:#e6eef6}
  .app{max-width:920px;margin:28px auto;background:linear-gradient(180deg,#071426,#061326);border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,.6);overflow:hidden;display:flex;flex-direction:column;height:85vh}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#062239;border-bottom:1px solid rgba(255,255,255,0.03)}
  header h1{margin:0;font-size:18px;color:var(--accent)}
  header .controls{display:flex;gap:8px;align-items:center}
  header select,input[type="range"]{background:#071427;border:1px solid rgba(255,255,255,0.04);color:#e6eef6;padding:6px;border-radius:6px}
  main{flex:1;display:flex;gap:12px;padding:16px}
  /* left chat */
  .chat-wrap{flex:1;display:flex;flex-direction:column;gap:12px}
  .chat-window{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;padding:14px;overflow:auto;display:flex;flex-direction:column;gap:10px}
  .msg{max-width:78%;padding:10px 14px;border-radius:14px;font-size:15px;line-height:1.3;box-shadow:0 4px 14px rgba(2,6,23,.35);word-break:break-word}
  .msg.user{align-self:flex-end;background:#052c4f;color:#fff;border-bottom-right-radius:4px}
  .msg.bot{align-self:flex-start;background:#ffffff;color:#081424;border-bottom-left-radius:4px}
  /* emotion classes for bot */
  .emotion-happy{background:var(--happy-bg); color:#1a1a1a}
  .emotion-sad{background:var(--sad-bg); color:#06324a}
  .emotion-angry{background:var(--angry-bg); color:#2e0505}
  .emotion-calm{background:var(--calm-bg); color:#06321a}
  .emotion-curious{background:var(--curious-bg); color:#2a1450}
  .emotion-anxious{background:#fff3d9;color:#4a3000}
  .emotion-hungry{background:#fff0e0;color:#4a2a00}
  .emotion-sleepy{background:#f0f7ff;color:#073057}
  .emotion-neutral{background:var(--neutral-bg); color:#081424}
  /* input */
  .composer{display:flex;gap:8px;padding-top:8px;align-items:center}
  .composer input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:#081727;color:#e6eef6}
  .btn{background:var(--accent);color:#022128;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted)}
  /* right panel */
  .side{width:320px;background:linear-gradient(180deg,#071a2a,#04121a);border-left:1px solid rgba(255,255,255,0.02);padding:12px;display:flex;flex-direction:column;gap:12px}
  .panel-card{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px}
  .panel-card h3{margin:0 0 8px 0;color:var(--accent);font-size:14px}
  .k-list{max-height:36vh;overflow:auto}
  .k-item{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);margin-bottom:6px}
  .k-item small{color:var(--muted)}
  footer{display:flex;gap:8px;align-items:center;padding:12px;background:#03151f;border-top:1px solid rgba(255,255,255,0.02)}
  footer .small{font-size:13px;color:var(--muted)}
  .badge{font-size:12px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);color:var(--muted)}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="TECLA Adapta PRIME">
    <header>
      <h1>üß† TECLA Adapta PRIME ‚Äî Chat com Emo√ß√µes</h1>
      <div class="controls" aria-hidden="false">
        <label class="badge">Voz</label>
        <select id="vozSelect" title="Selecionar voz"></select>
        <label class="badge">Vel</label>
        <input id="rate" type="range" min="0.6" max="1.6" step="0.1" value="1" />
        <label class="badge">Tom</label>
        <input id="pitch" type="range" min="0.7" max="1.4" step="0.1" value="1" />
      </div>
    </header>

    <main>
      <section class="chat-wrap" aria-live="polite">
        <div class="chat-window" id="chatWindow" role="log" aria-label="Mensagens do chat"></div>

        <div class="composer" aria-label="Composer">
          <input id="userInput" type="text" placeholder="Digite ou diga algo..." aria-label="Mensagem" />
          <button class="btn" id="sendBtn">Enviar</button>
          <button class="btn secondary" id="voiceBtn" title="Falar">üéôÔ∏è</button>
          <button class="btn secondary" id="teachBtn" title="Ensinar">üìò</button>
        </div>
      </section>

      <aside class="side" aria-hidden="false">
        <div class="panel-card">
          <h3>Estado atual</h3>
          <div id="currentEmotion" style="font-weight:600">Emo√ß√£o: <span style="color:var(--accent)">Neutra</span></div>
          <div style="margin-top:8px;font-size:13px;color:var(--muted)">Dica: Fala natural, breve, e o TECLA responde com suporte emocional.</div>
        </div>

        <div class="panel-card">
          <h3>Painel de Conhecimento</h3>
          <div class="k-list" id="knowledgeList" aria-live="polite"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn secondary" id="importBtn">Importar</button>
            <button class="btn secondary" id="exportBtn">Exportar</button>
            <input id="fileInput" type="file" accept=".json" style="display:none" />
          </div>
        </div>

        <div class="panel-card">
          <h3>Atalhos</h3>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button class="btn secondary" onclick="quick('estou feliz')">üôÇ Estou feliz</button>
            <button class="btn secondary" onclick="quick('estou triste')">üò¢ Estou triste</button>
            <button class="btn secondary" onclick="quick('preciso de ajuda')">üÜò Preciso de ajuda</button>
            <button class="btn secondary" onclick="quick('quero descansar')">üò¥ Quero descansar</button>
          </div>
        </div>
      </aside>
    </main>

    <footer>
      <button onclick="window.open('offline.html','_blank')">üíæ Usar Modo Offline</button>
      <div class="small">TECLA Adapta PRIME ¬∑ Offline/Local</div>
      <div style="flex:1"></div>
      <div class="small">Dala De Carvalho ‚Äî Educador Musical</div>
    </footer>
  </div>

<script>
/* ========== Configura√ß√£o inicial ========== */
const chatWindow = document.getElementById('chatWindow');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const voiceBtn = document.getElementById('voiceBtn');
const vozSelect = document.getElementById('vozSelect');
const rateControl = document.getElementById('rate');
const pitchControl = document.getElementById('pitch');
const knowledgeList = document.getElementById('knowledgeList');
const importBtn = document.getElementById('importBtn');
const exportBtn = document.getElementById('exportBtn');
const fileInput = document.getElementById('fileInput');
const teachBtn = document.getElementById('teachBtn');
const currentEmotion = document.getElementById('currentEmotion');

let respostas = {};      // estrutura: { chave: "resposta" } ou { chave: {resposta:"...", data:"..."} }
let localMode = false;   // se backend n√£o responder, salva em localStorage
const SAVE_ENDPOINT = '/save';
const DATA_ENDPOINT = '/data.json';

/* util: normalizar texto (minusculas sem acentos) */
function normalize(text){
  return text.toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
}

/* carregar dados do backend (ou localStorage) */
async function loadKnowledge(){
  try{
    const r = await fetch(DATA_ENDPOINT);
    if(!r.ok) throw new Error('no data');
    const data = await r.json();
    // aceitar objetos: se o JSON tem perfis, tentar pegar 'padrao'; caso contr√°rio usar diretamente
    if(data && typeof data === 'object' && !Array.isArray(data)){
      // if data is top-level mapping of keys to answers, use it
      respostas = {};
      for(const k in data){
        // if value is object with resposta field, extract
        const v = data[k];
        respostas[normalize(k)] = (v && typeof v === 'object' && v.resposta) ? v.resposta : v;
      }
      localMode = false;
    } else {
      respostas = {};
      localMode = true;
    }
  }catch(e){
    // fallback localStorage
    const stored = localStorage.getItem('tecla_respostas');
    respostas = stored ? JSON.parse(stored) : {};
    localMode = true;
  }
  renderKnowledgeList();
}
loadKnowledge();

/* salvar dados: tenta backend, se falhar salva localStorage */
async function saveKnowledge(){
  try{
    if(localMode){
      localStorage.setItem('tecla_respostas', JSON.stringify(respostas));
      return;
    }
    // backend expects entire object; try POST
    const r = await fetch(SAVE_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(respostas)
    });
    if(!r.ok) throw new Error('save failed');
  }catch(e){
    localMode = true;
    localStorage.setItem('tecla_respostas', JSON.stringify(respostas));
  }
  renderKnowledgeList();
}

/* ========== Emotion detection ========== */
/* keywords by emotion */
const emotionKeywords = {
  happy: ['feliz','alegre','otimo','bom','adoro','sorrir','maravilha','animado'],
  sad: ['triste','sinto','chorar','solitario','deprimido','nao consigo','sofrer'],
  angry: ['zangado','raiva','irritado','furioso','assoado','raiva'],
  calm: ['calmo','relaxar','tranquilo','sereno','respira','respirar'],
  curious: ['como','o que','por que','explica','quero aprender','perguntar'],
  anxious: ['ansioso','preocupado','nervoso','tenso'],
  hungry: ['fome','estou com fome','comer','sanduiche','jantar','almoco'],
  sleepy: ['sono','cansado','dormir','estou cansado','sonolento']
};

/* map emotion to CSS class and label */
const emotionMap = {
  happy: {cls:'emotion-happy', label:'Feliz'},
  sad: {cls:'emotion-sad', label:'Triste'},
  angry: {cls:'emotion-angry', label:'Zangado'},
  calm: {cls:'emotion-calm', label:'Calmo'},
  curious: {cls:'emotion-curious', label:'Curioso'},
  anxious: {cls:'emotion-anxious', label:'Ansioso'},
  hungry: {cls:'emotion-hungry', label:'Com Fome'},
  sleepy: {cls:'emotion-sleepy', label:'Sonolento'},
  neutral: {cls:'emotion-neutral', label:'Neutro'}
};

function detectEmotion(text){
  const t = normalize(text);
  // priority: explicit keywords
  for(const [emo, words] of Object.entries(emotionKeywords)){
    for(const w of words){
      if(t.includes(w)) return emo;
    }
  }
  // fallback simple heuristics
  if(t.includes('?') || t.startsWith('como') || t.startsWith('o que')) return 'curious';
  return 'neutral';
}

/* stylize bot message by emotion */
function createBotBubble(text, emotion='neutral'){
  const div = document.createElement('div');
  div.className = 'msg bot ' + (emotionMap[emotion] ? emotionMap[emotion].cls : emotionMap['neutral'].cls);
  div.textContent = text;
  return div;
}

/* ========== TTS (voz) ========== */
function populateVoices(){
  const synth = window.speechSynthesis;
  const voices = synth.getVoices();
  vozSelect.innerHTML = '';
  voices.filter(v=>v.lang.toLowerCase().includes('pt') || v.lang.toLowerCase().includes('pt-')).forEach(v=>{
    const opt = document.createElement('option');
    opt.value = v.name; opt.textContent = `${v.name} ‚Äî ${v.lang}`;
    vozSelect.appendChild(opt);
  });
  // fallback add if none
  if(vozSelect.options.length===0){
    voices.slice(0,5).forEach(v=>{ const opt=document.createElement('option'); opt.value=v.name; opt.textContent=`${v.name} ‚Äî ${v.lang}`; vozSelect.appendChild(opt); });
  }
}
window.speechSynthesis.onvoiceschanged = populateVoices;
populateVoices();

function speakText(text){
  if(!text) return;
  const synth = window.speechSynthesis;
  synth.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  const selected = vozSelect.value;
  if(selected){
    const voice = synth.getVoices().find(v=>v.name===selected);
    if(voice) utter.voice = voice;
  }
  utter.rate = parseFloat(rateControl.value || 1);
  utter.pitch = parseFloat(pitchControl.value || 1);
  utter.lang = 'pt-PT';
  synth.speak(utter);
}

/* ========== Chat logic (match + partial search + teach) ========== */
function appendUser(text){
  const d = document.createElement('div');
  d.className = 'msg user';
  d.textContent = 'üßë ' + text;
  chatWindow.appendChild(d);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function appendBot(text, emotion='neutral'){
  const bubble = createBotBubble(text, emotion);
  chatWindow.appendChild(bubble);
  chatWindow.scrollTop = chatWindow.scrollHeight;
  // update side panel
  currentEmotion.innerHTML = `Emo√ß√£o: <span style="color:var(--accent)">${emotionMap[emotion].label}</span>`;
  // speak
  speakText(text);
}

/* normalize keys in respostas to allow quick lookup */
function normalizedLookup(key){
  const k = normalize(key);
  if(respostas[k]) return respostas[k];
  // partial includes search (prioritize longer keys)
  const keys = Object.keys(respostas).sort((a,b)=>b.length - a.length);
  for(const kk of keys){
    if(k.includes(kk) || kk.includes(k)) return respostas[kk];
  }
  return null;
}

async function handleSend(rawText){
  const text = rawText.trim();
  if(!text) return;
  appendUser(text);

  // detect emotion from user text
  const emo = detectEmotion(text);

  // try to get answer
  let answer = normalizedLookup(text);
  if(answer){
    appendBot(answer, emo);
    return;
  }

  // if not found, ask to teach
  const question = '‚ùì N√£o sei responder. Deseja ensinar-me?';
  appendBot(question, 'curious');

  // prompt teacher
  setTimeout(async ()=>{
    const resp = prompt('Ensine a resposta para: "' + text + '" (deixa vazio para cancelar)');
    if(resp && resp.trim()){
      const key = normalize(text);
      respostas[key] = resp.trim();
      await saveKnowledge();
      appendBot('‚úîÔ∏è Aprendi: ' + resp.trim(), 'happy');
    } else {
      appendBot('Tudo bem ‚Äî n√£o aprendi dessa vez.', 'calm');
    }
  }, 300);
}

/* event handlers */
sendBtn.addEventListener('click', ()=>{ handleSend(userInput.value); userInput.value=''; });
userInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ handleSend(userInput.value); userInput.value=''; }});
voiceBtn.addEventListener('click', ()=>{
  // start speech recognition
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition){ alert('Reconhecimento de voz n√£o suportado neste navegador.'); return; }
  const rec = new SpeechRecognition();
  rec.lang = 'pt-PT';
  rec.onresult = (evt)=>{ const t = evt.results[0][0].transcript; userInput.value = t; handleSend(t); }
  rec.onerror = ()=>{ alert('Erro de reconhecimento de voz'); };
  rec.start();
});

/* teach button opens a simple modal prompt for quick teach */
teachBtn.addEventListener('click', ()=>{
  const q = prompt('Pergunta (o texto que algu√©m diria):');
  if(!q) return;
  const a = prompt('Resposta que TECLA deve dizer:');
  if(!a) return;
  respostas[normalize(q)] = a;
  saveKnowledge();
  appendBot('‚úîÔ∏è Aprendido: ' + a, 'happy');
});

/* quick shortcut */
function quick(text){ userInput.value = text; handleSend(text); }

/* ========== Knowledge panel rendering & import/export ========== */
function renderKnowledgeList(){
  knowledgeList.innerHTML = '';
  const keys = Object.keys(respostas).sort();
  if(keys.length===0){
    knowledgeList.innerHTML = '<div style="color:var(--muted)">Sem conte√∫dos carregados.</div>';
    return;
  }
  keys.forEach(k=>{
    const item = document.createElement('div'); item.className='k-item';
    const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:600">${k}</div><small>${respostas[k].slice(0,80)}${respostas[k].length>80?'...':''}</small>`;
    const right = document.createElement('div');
    const editBtn = document.createElement('button'); editBtn.textContent='‚úèÔ∏è'; editBtn.style.marginRight='6px';
    editBtn.onclick = async ()=>{ const n = prompt('Editar resposta para: '+k, respostas[k]); if(n){ respostas[k]=n; await saveKnowledge(); renderKnowledgeList(); } };
    const delBtn = document.createElement('button'); delBtn.textContent='üóëÔ∏è';
    delBtn.onclick = async ()=>{ if(confirm('Remover? '+k)){ delete respostas[k]; await saveKnowledge(); renderKnowledgeList(); } };
    right.appendChild(editBtn); right.appendChild(delBtn);
    item.appendChild(left); item.appendChild(right);
    knowledgeList.appendChild(item);
  });
}
function renderKnowledgeListDebounced(){ renderKnowledgeList(); }

/* import/export */
importBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = async ()=> {
    try{
      const parsed = JSON.parse(reader.result);
      // normalize keys and merge
      for(const k in parsed){
        const v = parsed[k];
        const val = (v && typeof v === 'object' && v.resposta) ? v.resposta : v;
        respostas[normalize(k)] = val;
      }
      await saveKnowledge();
      renderKnowledgeList();
      alert('Importado com sucesso.');
    }catch(e){ alert('JSON inv√°lido'); }
  };
  reader.readAsText(f);
});

exportBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(respostas,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'treinamento_tecla.json'; a.click();
});

/* wrapper to keep UI updated */
function atualizarPainel(){
  renderKnowledgeList();
}
function renderKnowledgeList(){
  renderKnowledgeListDebounced();
  setTimeout(()=>{ renderKnowledgeListDebounced(); }, 30);
}

/* initial rendering */
setTimeout(()=>{ renderKnowledgeList(); }, 200);

/* expose for debugging */
window._tecla = {respostas, loadKnowledge, saveKnowledge, detectEmotion};

/* finalize save on unload */
window.addEventListener('beforeunload', ()=>{ try{ localStorage.setItem('tecla_respostas', JSON.stringify(respostas)); }catch{} });

</script>
</body>
</html>
